image: ubuntu:latest

variables:
  AWS_REGION: "us-east-1"
  AWS_ROLE_ARN: "arn:aws:iam::211125629230:role/TiledbCloudPyCIRole"
  AWS_S3_BUCKET: "tiledb-cloud-py-ci"

stages:
  - aws-oidc-credentials
  - check-aws-credentials

.aws-cli:
  image:
    name: "amazon/aws-cli:latest"
    entrypoint: [""]

# Copied from official docs:
# https://docs.gitlab.com/ee/ci/cloud_services/aws/#retrieve-temporary-credentials
aws-oidc-credentials:
  stage: aws-oidc-credentials
  extends: .aws-cli
  id_tokens:
    OIDC_TOKEN:
      aud: https://ecs.customerapp.com
  variables:
    AWS_PROFILE: oidc
  before_script:
    - mkdir -p ~/.aws
    - echo "${OIDC_TOKEN}" > /tmp/web_identity_token
    - echo -e "[profile oidc]\nrole_arn=${AWS_ROLE_ARN}\nweb_identity_token_file=/tmp/web_identity_token" > ~/.aws/config
  script:
    - aws sts get-caller-identity

check-aws-credentials:
  stage: check-aws-credentials
  needs: [aws-oidc-credentials]
  extends: .aws-cli
  script:
    - aws s3 ls s3://${AWS_S3_BUCKET}
